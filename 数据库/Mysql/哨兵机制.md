## 哨兵机制的基本流程
- 总流程
![01](./../Redis/redis-sb-01.jpg)

- 监控
  - 主观下线  
    redis哨兵进程会定时Ping主从库来判断是否及时响应。若未及时响应，则该哨兵会标记该库为主观下线。此时还不一定立马做后续的选主操作。
  - 客观下线  
    redis哨兵再被判定为主观下线后，不排除因网络问题而造成的误判情况，此时一般会通过哨兵集群来减少误差。如果一个哨兵判定为主观下线后，会通知其他哨兵Ping库，根据主观下线的数量比例（具体比例可以配置），来判定此库是否的确下线，减少误差。此时的下线被称为“客观下线”

- 选主
  ![02](./../Redis/redis-sb-02.jpg)
  - 筛选  
    在选主时，除了要检查从库的当前在线状态，还要判断它之前的网络连接状态。如果从库总是和主库断连，而且断连次数超出了一定的阈值，我们就有理由相信，这个从库的网络状况并不是太好，就可以把这个从库筛掉了。  

    具体怎么判断呢？你使用配置项down-after-milliseconds * 10。其中，down-after-milliseconds是我们认定主从库断连的最大连接超时时间。如果在down-after-milliseconds毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果发生断连的次数超过了10次，就说明这个从库的网络状况不好，不适合作为新主库。

  - 打分  
    1. **优先级最高的从库得分高。**  
    用户可以通过slave-priority配置项，给不同的从库设置不同优先级。比如，你有两个从库，它们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么它就是新主库了。如果从库的优先级都一样，那么哨兵开始第二轮打分。
    2. **和旧主库同步程度最接近的从库得分高。**     
    主从库同步时有个命令传播的过程。在这个过程中，主库会用master_repl_offset记录当前的最新写操作在repl_backlog_buffer中的位置，而从库会用slave_repl_offset这个值记录当前的复制进度。  
    此时，我们想要找的从库，它的slave_repl_offset需要最接近master_repl_offset。如果在所有从库中，有从库的slave_repl_offset最接近master_repl_offset，那么它的得分就最高，可以作为新主库。
    3. **ID号小的从库得分高。**  
    每个实例都会有一个ID，这个ID就类似于这里的从库的编号。目前，Redis在选主库时，有一个默认的规定：在优先级和复制进度都相同的情况下，ID号最小的从库得分最高，会被选为新主库。